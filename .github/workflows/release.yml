name: Create Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 0.2.0)'
        required: true
        type: string
      release_type:
        description: 'Release type'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Need full history for changelog

      - name: Get changes since last release
        id: changes
        run: |
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -z "$LAST_TAG" ]; then
            CHANGES=$(git log --oneline)
          else
            CHANGES=$(git log ${LAST_TAG}..HEAD --oneline)
          fi
          echo "changes<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Generate release notes with Gemini
        id: notes
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        run: |
          PROMPT="Generate concise release notes for version ${{ inputs.version }}.
          Summarize these commits into user-friendly categories (Features, Fixes, etc.):

          ${{ steps.changes.outputs.changes }}

          Format as markdown. Be brief but informative."

          RESPONSE=$(curl -s "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=$GOOGLE_API_KEY" \
            -H "Content-Type: application/json" \
            -d "{\"contents\":[{\"parts\":[{\"text\":\"$PROMPT\"}]}]}")

          NOTES=$(echo "$RESPONSE" | jq -r '.candidates[0].content.parts[0].text')
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          echo "$NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Update version in pyproject.toml
        run: |
          sed -i 's/^version = .*/version = "${{ inputs.version }}"/' pyproject.toml

      - name: Update CHANGELOG.md
        run: |
          DATE=$(date +%Y-%m-%d)
          NOTES="${{ steps.notes.outputs.notes }}"
          # Prepend new version to changelog after the header
          sed -i "/^## \[/i\\
          ## [${{ inputs.version }}] - $DATE\\
          \\
          $NOTES\\
          " CHANGELOG.md

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add pyproject.toml CHANGELOG.md
          git commit -m "Release v${{ inputs.version }}"
          git push

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release create "v${{ inputs.version }}" \
            --title "v${{ inputs.version }}" \
            --notes "${{ steps.notes.outputs.notes }}"
